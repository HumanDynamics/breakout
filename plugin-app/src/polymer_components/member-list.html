<dom-module id="member-list">

    <template>
        <template is="dom-repeat" items="{{talkers}}">
            <paper-card heading="{{item.talker}}" image="{{item.image}}">
                <div class="card-content">{{item.talker}}</div>
                <div class="card-actions">
                </div>
            </paper-card>
        </template>
    </template>

    <script>
     Polymer({
         is: "member-list",

         properties: {
             talkers: {
                 type: Array,
                 notify: true,
             },
         },
         
         ready: function() {
             this.hangoutId = state.getHangoutId();
             this.conn = new Asteroid(window.meteorURL, true);
             this.conn.subscribe('talkers');
             this.talkers = [];
             //TODO: needs to use the computed hangoutId from lib.js
             this.talkerCollection = this.conn.getCollection('talkers');
             console.log("hangoutid: ", this.hangoutId);
             var _this = this;

             Promise.resolve(this.hangoutId).then(function(hangoutId) {
                 // all talkers in this hangout
                 _this.talkerRQ = _this.talkerCollection.reactiveQuery(function(item) {
                     return item.hangout_id == hangoutId;
                 });
                 
                 // make the talkers array reactive
                 _this.talkerRQ.on("change", function (item) {
                     console.log("talker on change!!", _this.talkerRQ.result);
                     _this.talkers = _this.talkerRQ.result;
                 });
             }, function(error) {
                 console.log("couldnt get hangout ID!");
             });


             // hangout api
             gapi.hangout.onApiReady.add(function(eventObj) {
                 // initialize users for this hangout
                 var users = gapi.hangout.getParticipants();
                 _this.updateUsers(gapi.hangout.getParticipants());

                 // update when they change
                 gapi.hangout.onEnabledParticipantsChanged.add(function() {
                     _this.updateUsers(gapi.hangout.getParticipants());
                 });

             });

         },

         // udpate the users in this hangout
         // gets called when users enter or leave.
         updateUsers: function(users) {
             var _this = this;
             for (var i = 0; i < users.length; i++) {
                 var u = users[i];
                 _this.talkerCollection.insert({
                     "talker": u.person.displayName,
                     "image": u.person.image.url,
                     "hangout_id": this.hangoutId,
                     "gid": u.person.id
                 });
             }
         },
         
     });
    </script>
</dom-module>
